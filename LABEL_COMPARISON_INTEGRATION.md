# ラベル比較機能の統合

## 概要

DXF-diff-managerプロジェクトのラベル比較機能をDXF-visual-diffに統合しました。これにより、DXFファイルペアの視覚的な差分比較に加えて、ラベル（テキストエンティティ）の変更を詳細に分析するExcelファイルが自動生成されます。

## 追加された機能

### 1. ラベル差分分析（diff_labels.xlsx）

各ファイルペアについて、座標ごとにラベルの変更を検出し、Excelファイルとして出力します。

**出力形式:**
- シート名: 比較対象ファイル（B）の名前（拡張子なし）
- 各シートの列:
  - `Coordinate X`: X座標
  - `Coordinate Y`: Y座標
  - `Old: {ファイルA名}`: 基準ファイル（A）のラベル
  - `New: {ファイルB名}`: 比較対象ファイル（B）のラベル

**検出される変更:**
- ラベルの追加（Old Label が None）
- ラベルの削除（New Label が None）
- ラベルの名称変更（同一座標で異なるラベル）

### 2. 未変更ラベル分析（unchanged_labels.xlsx）

指定されたプレフィックスに一致する未変更ラベルを抽出し、Excelファイルとして出力します。

**出力形式:**
- シート名: 比較対象ファイル（B）の名前（拡張子なし）
- 各シートの列:
  - `Label`: ラベルテキスト
  - `Count`: 同一座標での出現回数
  - `Coordinate X`: X座標
  - `Coordinate Y`: Y座標

**フィルタリング:**
- `prefix_config.txt` に記載されたプレフィックスで始まるラベルのみを抽出
- デフォルト設定: `W No.`
- UI上で動的にプレフィックスを変更可能

## 追加されたファイル

### utils/label_diff.py
ラベル比較のコアロジックを提供します。

**主要な関数:**
- `compute_label_differences()`: 2つのDXFファイル間のラベル差分を計算
- `filter_unchanged_by_prefix()`: プレフィックスで未変更ラベルをフィルタリング
- `build_diff_labels_workbook()`: diff_labels.xlsx を生成
- `build_unchanged_labels_workbook()`: unchanged_labels.xlsx を生成

### utils/extract_labels.py
DXFファイルからテキストラベルを抽出します。

**主要な機能:**
- TEXT, MTEXT エンティティの抽出
- MODEL_SPACE, PAPER_SPACE, BLOCKS からの抽出
- INSERT エンティティ（ブロック参照）の展開
- MTEXTフォーマットコードのクリーニング
- 座標情報の取得

### prefix_config.txt
未変更ラベルのフィルタリングに使用するプレフィックスのリスト。

**デフォルト設定:**
```
W No.
```

## UI の変更

### オプション設定セクション

新しく「ラベル比較設定」が追加されました:

- **未変更ラベルのフィルタリング用プレフィックス**: テキストエリアで複数のプレフィックスを指定可能
  - 1行に1つのプレフィックスを記載
  - 例: `W No.`, `R`, `C` など

### ダウンロードセクション

DXFファイルのダウンロードに加えて、以下が追加されました:

- **📊 ラベル比較結果 (Excel)** セクション
  - `diff_labels.xlsx` のダウンロードボタン
  - `unchanged_labels.xlsx` のダウンロードボタン
  - 各ファイルの説明キャプション

### ZIPアーカイブダウンロード

複数ペアを処理した場合、ZIPアーカイブに以下が含まれます:
- 全てのDXF差分ファイル
- `diff_labels.xlsx`（全ペアの結果を含む）
- `unchanged_labels.xlsx`（全ペアの結果を含む）

## 処理フロー

1. ユーザーがファイルペアを登録
2. 「DXF差分を比較」ボタンをクリック
3. 各ペアについて:
   a. DXF視覚的差分を生成（既存機能）
   b. **[新]** ラベル差分を計算
   c. **[新]** プレフィックスで未変更ラベルをフィルタリング
4. **[新]** 全ペアの結果をExcelワークブックに統合
5. DXFファイルとExcelファイルをダウンロード可能にする

## 座標許容誤差の適用

ラベル比較でも、DXF比較と同じ座標許容誤差が適用されます:
- デフォルト: 0.01 DXF単位
- 座標を許容誤差で丸めて比較
- 微小な位置ずれを無視

## 依存関係の追加

`requirements.txt` に以下が追加されました:
- `pandas>=2.0.0`: データ処理
- `xlsxwriter>=3.0.0`: Excel生成
- `openpyxl>=3.1.0`: Excel読み書き

## 使用例

### 基本的な使用方法

1. ファイルペアを登録
2. （オプション）「オプション設定」でプレフィックスを調整
   ```
   W No.
   R
   C
   ```
3. 「DXF差分を比較」をクリック
4. DXFファイルとExcelファイルをダウンロード

### 出力されるExcelファイルの内容

**diff_labels.xlsx の例:**

| Coordinate X | Coordinate Y | Old: FileA | New: FileB |
|--------------|--------------|------------|------------|
| 100.50       | 200.30       | R10        | R12        |
| 150.20       | 180.40       | C5         | None       |
| 200.10       | 220.50       | None       | L3         |

**unchanged_labels.xlsx の例:**

| Label   | Count | Coordinate X | Coordinate Y |
|---------|-------|--------------|--------------|
| W No.1  | 2     | 100.00       | 200.00       |
| W No.2  | 1     | 150.00       | 180.00       |

## 注意事項

- ラベル比較はDXF比較が成功したペアにのみ実行されます
- プレフィックスが指定されていない場合、unchanged_labels.xlsx は空になります
- 大量のテキストエンティティを含むDXFファイルでは処理に時間がかかる場合があります
- Excelシート名は31文字に制限されます（Excel仕様）

## トラブルシューティング

### unchanged_labels.xlsx が生成されない

- プレフィックス設定を確認してください
- DXFファイルに該当するラベルが存在するか確認してください

### ラベル比較でエラーが発生する

- DXFファイルが正しい形式か確認してください
- TEXT/MTEXT エンティティが含まれているか確認してください
- 座標許容誤差の値を調整してみてください

## 今後の拡張可能性

- [ ] レイヤー別のラベル比較
- [ ] ラベル種類別の統計情報
- [ ] 図面番号の自動抽出と表示
- [ ] タイトル/サブタイトルの抽出
- [ ] カスタムラベルフィルタリングルール
