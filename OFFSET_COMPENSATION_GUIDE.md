# オフセット補正機能 使用ガイド

## 概要

DXF-visual-diffにオフセット補正機能が追加されました。この機能により、基準点の違いによる誤検知を大幅に減らすことができます。

## 機能の目的

DXFファイルを比較する際、実際には同じ内容でも**基準点（原点）が異なる**ために、すべての要素が「異なる位置」として検出されてしまう問題を解決します。

### 例：
- ファイルA: すべての要素が (0, 0) 基準
- ファイルB: すべての要素が (-2.6, -7.1) だけずれている
- 実際の内容は同じなのに、70%以上が「差分あり」と誤検出される

→ **オフセット補正を適用すると**: 誤検知を20-30%程度削減可能

## 使い方

### ステップ1: オフセット値を分析

まず、`analyze_offset.py` を使って2つのDXFファイル間のオフセットを分析します。

```bash
source venv/bin/activate
python analyze_offset.py ファイルA.dxf ファイルB.dxf
```

**出力例:**
```
================================================================================
分析サマリー
================================================================================

1. 変更なしラベル (offset ≈ 0.0, 0.0): 408 (29.35%)

2. 支配的シフトパターン (offset = (-2.6, -7.1)):
   Count: 319 (22.95%)
   このオフセットを持つラベルのグループが一緒に移動したと考えられます。

================================================================================
仮説の検証:
================================================================================

補正なしの場合:
  - 70.6% のラベルが異なる位置にあります

支配的オフセット (-2.6, -7.1) で補正した場合:
  - 22.9% の差分を補正できます
  - 残りの差分: 47.7%

**結論:**
  ✓ 仮説は部分的に有効です
  ✓ 支配的なオフセットパターンが存在します ((-2.6, -7.1))
  ✓ このオフセット補正により誤検知を22.9%減らせます
```

### ステップ2: 支配的オフセット値を確認

上記の例では、**支配的シフトパターン = (-2.6, -7.1)** です。

この値をメモしてください。

### ステップ3: DXF-visual-diffでオフセットを適用

1. Streamlit アプリを起動:
   ```bash
   streamlit run app.py
   ```

2. **ファイルペア登録** セクションで、ファイルA（基準）とファイルB（比較対象）をアップロード
   - **重要**: `analyze_offset.py` と同じ順序でファイルを指定してください

3. **オフセット補正設定（オプション）** セクションを開く

4. 該当ペアの設定:
   - 「オフセット補正を有効化」にチェック
   - dx: `-2.6` を入力
   - dy: `-7.1` を入力

5. 「DXF差分を比較」ボタンをクリック

### ステップ4: 結果を確認

生成されたDXFファイルを開くと、オフセット補正が適用された状態で差分が表示されます。

## 重要な注意事項

### ファイルの順序

`analyze_offset.py` と DXF-visual-diff で**ファイルの順序を統一**してください。

**正しい例:**
```bash
# 分析
python analyze_offset.py EE3273-601-09B.dxf EE4475-300-01G.dxf
# → 支配的オフセット: (-2.6, -7.1)

# DXF-visual-diff
# ファイルペア登録:
#   基準ファイル(A): EE3273-601-09B.dxf
#   比較対象ファイル(B): EE4475-300-01G.dxf
#   オフセット: (-2.6, -7.1)
```

**間違った例:**
```bash
# 分析
python analyze_offset.py EE3273-601-09B.dxf EE4475-300-01G.dxf
# → 支配的オフセット: (-2.6, -7.1)

# DXF-visual-diff
# ファイルペア登録:
#   基準ファイル(A): EE4475-300-01G.dxf  ← 順序が逆！
#   比較対象ファイル(B): EE3273-601-09B.dxf
#   オフセット: (-2.6, -7.1)  ← この値は逆向きになるべき
```

### オフセットの符号

`analyze_offset.py` の結果をそのまま使用してください。符号を反転させる必要はありません。

### 複数ペアの処理

各ペアごとに異なるオフセット値を設定できます。

**例:**
- ペア1: オフセット (-2.6, -7.1)
- ペア2: オフセット (0, 0) - 補正なし
- ペア3: オフセット (10.5, -77.6)

## オフセット補正を使うべきケース

### 使うべき場合

`analyze_offset.py` の結果で以下の条件を満たす場合:

✅ **補正可能な割合 > 15%**
```
支配的オフセット補正後:
  - 22.9% の差分を補正できます  ← 15%以上
```

→ オフセット補正を実装する価値があります

### 使わなくてよい場合

❌ **補正可能な割合 < 10%**
```
支配的オフセット補正後:
  - 5.2% の差分を補正できます  ← 10%未満
```

→ 効果が限定的。実際の差分が主要因です

### 判断が難しい場合 (10-15%)

⚠️ **状況により判断**
```
支配的オフセット補正後:
  - 12.3% の差分を補正できます  ← 10-15%
```

→ 試してみて、結果を確認してください

## トラブルシューティング

### Q: オフセット補正を適用したのに差分が減らない

**原因1**: ファイルの順序が逆
- `analyze_offset.py` と DXF-visual-diff でファイルの順序を確認

**原因2**: オフセット値が間違っている
- `analyze_offset.py` の結果を再確認
- 符号（+/-）が正しいか確認

**原因3**: そもそも補正効果が小さい
- `analyze_offset.py` の「補正可能な割合」を確認
- 10%未満の場合は効果が限定的

### Q: 補正後も50%以上の差分が残る

これは正常です。`analyze_offset.py` の結果:
```
残りの差分: 47.7%
```

残りの差分は以下の可能性があります:
- 実際のコンテンツ変更
- 複数の異なる基準点が使用されている
- 要素が個別に移動されている

### Q: 複数のオフセットパターンがある場合は？

`analyze_offset.py` で複数のクラスタが検出される場合:
```
Rank   Offset (dx, dy)         Count      %
1      (0.00, 0.00)           408       29.35%
2      (-2.60, -7.10)         319       22.95%
3      (-2.60, 42.90)         41         2.95%
4      (-2.60, 27.90)         20         1.44%
```

→ **最も大きいクラスタ（Rank 2）のオフセットを使用**してください

現時点では単一オフセットのみサポートしています。

## 技術的な詳細

### オフセット補正の仕組み

1. ファイルBの**すべての要素**に対してオフセット (dx, dy) を適用
2. 座標変換後に比較を実行
3. 結果として、オフセットが補正された状態の差分DXFが生成される

### 適用される要素

以下のすべての要素に適用されます:
- LINE (開始点、終了点)
- CIRCLE (中心点)
- ARC (中心点)
- ELLIPSE (中心点)
- TEXT / MTEXT (挿入点)
- LWPOLYLINE (すべての頂点)
- その他の図形要素

### 出力DXFファイルについて

生成されるDXFファイルでは:
- **DELETED** レイヤー: ファイルAのみの要素（補正は適用されない）
- **ADDED** レイヤー: ファイルBのみの要素（**補正が適用済み**）
- **UNCHANGED** レイヤー: 両方に存在する要素（補正適用後に一致した要素）

## まとめ

1. `analyze_offset.py` で分析 → オフセット値を取得
2. DXF-visual-diff で同じファイル順序で比較
3. オフセット補正設定でオフセット値を入力
4. 補正可能な割合が15%以上なら効果的

**メリット:**
- 基準点の違いによる誤検知を減らせる
- より正確な差分比較が可能

**制限事項:**
- 単一オフセットのみサポート
- すべての差分を解消できるわけではない
- ファイル順序の厳守が必要
